<!DOCTYPE html>
<html>
<head>
    <title>个人资料</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .profile-container {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            background: #f5f5f5;
        }
        .user-info {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>个人资料</h1>
    <div class="profile-container">
        <h3>用户信息</h3>
        <div class="user-info">
            <p><strong>用户名:</strong> <span id="username">加载中...</span></p>
            <p><strong>邮箱:</strong> <span id="email">加载中...</span></p>
            <p><strong>手机:</strong> <span id="mobile">加载中...</span></p>
            <p><strong>UUID:</strong> <span id="uuid">加载中...</span></p>
        </div>
        <div style="margin-top: 20px;">
            <form id="logout-form" action="/api/v1/iam/logout/" method="post" style="display:inline;">
                <button type="submit" style="padding: 6px 16px; background: #d32f2f; color: #fff; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">登出</button>
            </form>
            <button type="button" onclick="window.location.href='/admin/'" style="margin-left: 20px; padding: 6px 16px; background: #1976d2; color: #fff; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">站点管理</button>
        </div>
    </div>

    <script>
        // API 基础 URL
        const API_BASE_URL = '';

        // 使用闭包在内存中存储token
        const tokenManager = (function() {
            let accessToken = null;
            
            return {
                getToken: function() {
                    return accessToken;
                },
                setToken: function(token) {
                    accessToken = token;
                },
                clearToken: function() {
                    accessToken = null;
                }
            };
        })();

        // 获取access token，如果没有则自动刷新
        async function getAccessToken() {
            let token = tokenManager.getToken();
            if (!token) {
                // 自动刷新
                const resp = await fetch(`${API_BASE_URL}/api/v1/iam/token/refresh/`, { method: 'POST', credentials: 'include' });
                if (resp.status === 401) {
                    window.location.href = '/api/v1/iam/unauthorized/?next=' + encodeURIComponent(window.location.pathname);
                    return null;
                }
                const data = await resp.json();
                token = data.jwt_access;
                tokenManager.setToken(token);
            }
            return token;
        }

        // 封装API请求，自动带Authorization，自动处理401
        async function authFetch(url, options = {}) {
            let token = await getAccessToken();
            if (!token) return; // 已跳转
            let resp = await fetch(`${API_BASE_URL}${url}`, {
                ...options,
                headers: {
                    ...options.headers,
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });
            if (resp.status === 401) {
                // token 失效，尝试刷新
                tokenManager.clearToken();
                token = await getAccessToken();
                if (!token) return;
                // 重试
                resp = await fetch(`${API_BASE_URL}${url}`, {
                    ...options,
                    headers: {
                        ...options.headers,
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include'
                });
                if (resp.status === 401) {
                    window.location.href = '/api/v1/iam/unauthorized/?next=' + encodeURIComponent(window.location.pathname);
                    return;
                }
            }
            return resp;
        }

        function loadUserInfo() {
            authFetch('/api/v1/iam/users/me/')
            .then(response => {
                if (!response) return;
                if (response.ok) {
                    return response.json().then(userData => {
                        document.getElementById('username').textContent = userData.username || '未设置';
                        document.getElementById('email').textContent = userData.email || '未设置';
                        document.getElementById('mobile').textContent = userData.mobile || '未设置';
                        document.getElementById('uuid').textContent = userData.uuid || '未设置';
                    });
                } else {
                    window.location.href = '/api/v1/iam/unauthorized/?next=' + encodeURIComponent(window.location.pathname);
                }
            })
            .catch(error => {
                console.error('获取用户信息失败:', error);
                window.location.href = '/api/v1/iam/unauthorized/?next=' + encodeURIComponent(window.location.pathname);
            });
        }

        // 页面获得焦点时检查token
        window.addEventListener('focus', () => getAccessToken());
        // 页面加载完成后加载用户信息
        document.addEventListener('DOMContentLoaded', loadUserInfo);

        // 登出逻辑，清除内存中的token
        document.getElementById('logout-form').onsubmit = function(e) {
            e.preventDefault();
            tokenManager.clearToken();
            // 使用 fetch 发送 POST 请求到登出接口
            fetch(`${API_BASE_URL}/api/v1/iam/logout/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include'  // 确保发送 cookies
            })
            .then(response => {
                window.location.href = '/api/v1/iam/unauthorized/';
            })
            .catch(error => {
                console.error('Logout error:', error);
                window.location.href = '/';
            });
        };

        // 鼠标移入页面时检查 refresh token 是否有效
        document.body.addEventListener('mouseenter', function() {
            fetch('/api/v1/iam/token/check/', {
                method: 'GET',
                credentials: 'include'
            })
            .then(resp => {
                if (resp.status === 401) {
                    alert('登录已失效，请重新登录。');
                    window.location.href = '/api/v1/iam/login/?next=' + encodeURIComponent(window.location.pathname);
                }
            })
            .catch(err => {
                console.error('Token check error:', err);
            });
        });
    </script>
</body>
</html>
